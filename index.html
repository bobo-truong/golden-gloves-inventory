<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golden Gloves – Quản lý tồn kho</title>
  <style>
    :root{--bg:#0d1219;--panel:#161b25;--muted:#2a2f3a;--text:#e5e7eb;--sub:#9ca3af;--accent:#b8860b;--accent-2:#0284c7;--danger:#dc2626;--ok:#16a34a;--warn:#d97706;--shadow:0 10px 24px rgba(0,0,0,.25)}
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{background:radial-gradient(1200px 800px at 80% -20%, rgba(184,134,11,.08), transparent 58%),radial-gradient(1000px 700px at -20% 110%, rgba(2,132,199,.07), transparent 58%),var(--bg);color:var(--text);font-size:14px;line-height:1.6}
    header{background:rgba(13,18,25,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--muted);position:sticky;top:0;z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:0 18px}
    .brand{display:flex;align-items:center;gap:12px;padding:12px 0}
    .brand h1{font-size:18px;font-weight:600;color:var(--accent)}
    .logo{background:var(--accent);padding:4px;border-radius:50%;display:grid;place-items:center}
    .tabs{display:flex;gap:4px;border-bottom:1px solid transparent}
    .tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;opacity:.7;font-weight:500}
    .tab:hover{opacity:1;color:var(--accent-2)}
    .tab.active{opacity:1;border-bottom-color:var(--accent);color:var(--accent)}
    main{padding:24px 0}
    section{display:grid;gap:24px}
    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:12px;box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;padding:12px 18px;border-bottom:1px solid var(--muted)}
    .hd h2{font-size:16px;font-weight:600}
    .bd{padding:18px}
    .grid{display:grid;gap:18px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5,1fr)}
    .row{display:flex;flex-wrap:wrap;gap:18px}
    .row>*{flex:1;min-width:150px}
    .flex{display:flex;align-items:center;gap:10px}
    .stat{padding:12px;text-align:center;border-right:1px solid var(--muted)}
    .stat:last-child{border:none}
    .stat .k{font-size:12px;color:var(--sub);margin-bottom:4px}
    .stat .v{font-size:20px;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--muted)}
    th{font-size:12px;font-weight:600;color:var(--sub);text-transform:uppercase}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .btn,label.btn{display:inline-block;padding:8px 16px;border:1px solid var(--muted);border-radius:8px;background:var(--bg);color:var(--text);cursor:pointer;font-weight:500;transition:all .2s}
    .btn:hover,label.btn:hover{border-color:var(--accent);color:var(--accent)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{opacity:.9}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.ghost{background:transparent}
    .btn svg{vertical-align:middle;margin-right:6px}
    input,select{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--muted);border-radius:8px;color:var(--text)}
    input:focus,select:focus{outline:none;border-color:var(--accent-2)}
    label{font-size:13px;font-weight:500;margin-bottom:6px;display:block}
    .right{margin-left:auto}
    .search{position:relative}
    .search input{padding-left:36px}
    .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.6}
    .hint{font-size:12px;color:var(--sub)}
    .tag{font-size:11px;opacity:.9}
    .foot{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--muted);padding:12px 18px}
    .badge{padding:3px 8px;border-radius:8px;border:1px solid #2a2f3a;font-size:11px;color:#cbd5e1;background:#0d1219}
    .nowrap{white-space:nowrap}
    .center{display:grid;place-items:center}
    .hidden{display:none}
    .toast{position:fixed;right:18px;bottom:18px;background:#0b1220;border:1px solid #203047;color:#dce7f8;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(12px);transition:all .3s}
    .toast.show{opacity:1;transform:none}
    [data-theme="light"]{--bg:#f5f7fb;--panel:#ffffff;--muted:#e2e8f0;--text:#0b1220;--sub:#4b5563;--accent:#b8860b;--accent-2:#0284c7;--danger:#dc2626;--ok:#16a34a;--warn:#d97706;--shadow:0 10px 24px rgba(0,0,0,.08)}
    [data-theme="light"] body{background:radial-gradient(1200px 800px at 80% -20%, rgba(184,134,11,.12), transparent 58%),radial-gradient(1000px 700px at -20% 110%, rgba(2,132,199,.10), transparent 58%),var(--bg)}
    @media print{header,.tabs,.toast,.foot,#tabs,.btn{display:none!important}body{background:#fff;color:#000}.panel{border:none;box-shadow:none}.wrap{max-width:100%}main{padding:0}table{font-size:12px}th,td{padding:8px}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12c0-3 2-7 6-7s6 4 6 7-2 7-6 7-6-4-6-7Z" stroke="#2a1f08" stroke-width="2"/><path d="M7 11c1 0 2 1 2 2v2c0 1 1 1 2 1s2 0 2-1v-2c0-1 1-2 2-2" stroke="#000" stroke-opacity=".35" stroke-width="2"/><path d="M6 12c0-3 2-7 6-7s6 4 6 7-2 7-6 7-6-4-6-7Z" fill="#f0cd69" fill-opacity=".95"/></svg>
        </div>
        <h1>Golden Gloves – Quản lý tồn kho</h1>
        <span class="right badge">Bản đơn máy – dữ liệu lưu cục bộ</span>
        <button class="btn right" id="theme-toggle" style="margin-left:auto">Đổi theme</button>
      </div>
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="dash">Tổng quan</div>
        <div class="tab" data-tab="products">Sản phẩm</div>
        <div class="tab" data-tab="txn">Giao dịch</div>
        <div class="tab" data-tab="count">Kiểm kê</div>
        <div class="tab" data-tab="report">Báo cáo</div>
        <div class="tab" data-tab="settings">Cài đặt</div>
      </div>
    </div>
  </header>
  <main>
    <section class="wrap" id="view-dash">
      <div class="grid cols-3">
        <div class="panel"><div class="hd"><h2>Chỉ số nhanh</h2></div><div class="bd grid cols-3"><div class="stat"><div class="k">Số SKU</div><div class="v" id="stat-skus">0</div></div><div class="stat"><div class="k">Tổng tồn (hộp)</div><div class="v" id="stat-stock">0</div></div><div class="stat"><div class="k">Giá trị tồn (VND)</div><div class="v" id="stat-value">0</div></div></div></div>
        <div class="panel"><div class="hd"><h2>Cảnh báo đặt hàng</h2></div><div class="bd" id="low-list"><div class="hint">Chưa có cảnh báo.</div></div></div>
        <div class="panel"><div class="hd"><h2>Hạn dùng sắp tới (FEFO)</h2></div><div class="bd" id="exp-list"><div class="hint">Chưa có lô hàng nào có hạn dùng.</div></div></div>
      </div>
      <div class="panel">
        <div class="hd"><h2>Tồn kho hiện tại</h2><div class="search"><input id="dash-search" placeholder="Tìm theo tên, SKU, size, màu…"/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.2-4.2" stroke="#8aa0b8" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#8aa0b8" stroke-width="2"/></svg></div></div>
        <div class="bd">
          <div class="row cols-5" style="margin-bottom:10px">
            <select id="f-size"><option value="">Size (tất cả)</option><option>S</option><option>M</option><option>L</option><option>XL</option></select>
            <select id="f-color"><option value="">Màu (tất cả)</option><option>Xanh</option><option>Trắng</option><option>Đen</option></select>
            <select id="f-material"><option value="">Chất liệu</option><option>Nitrile</option><option>Latex</option></select>
            <select id="f-status"><option value="">Tình trạng</option><option value="low">Cần đặt</option><option value="ok">Đủ</option></select>
            <select id="f-warehouse"><option value="">Kho (tất cả)</option></select>
          </div>
          <div style="overflow-x:auto"><table id="stock-table"><thead><tr><th>SKU</th><th>Tên sản phẩm</th><th>Thuộc tính</th><th class="nowrap">Tồn (hộp)</th><th>Điểm đặt</th><th>Giá vốn/hộp</th><th>Giá trị tồn</th><th>Lô/HSD gần nhất</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </section>
    <section class="wrap hidden" id="view-products">
      <div class="panel">
        <div class="hd"><h2>Danh mục sản phẩm</h2><div class="flex right"><button class="btn" id="btn-export-products">Xuất CSV</button><label class="btn ghost" for="import-products">Nhập CSV<input id="import-products" type="file" accept=".csv" style="display:none"></label></div></div>
        <div class="bd"><div style="overflow-x:auto"><table id="prod-table"><thead><tr><th>SKU</th><th>Tên</th><th>Size</th><th>Màu</th><th>Chất liệu</th><th>Độ dày (mil)</th><th>Găng/hộp</th><th>Hộp/thùng</th><th>Giá vốn</th><th>Giá bán</th><th>Điểm đặt</th><th></th></tr></thead><tbody></tbody></table></div></div>
        <div class="foot"><button class="btn primary" id="btn-new-prod">+ Thêm sản phẩm</button></div>
      </div>
      <div class="panel" id="prod-form-panel" style="display:none">
        <div class="hd"><h2 id="prod-form-title">Thêm sản phẩm</h2></div>
        <div class="bd"><form id="prod-form" class="grid"><div class="row cols-3"><div><label>SKU</label><input id="p-sku" required></div><div><label>Tên sản phẩm</label><input id="p-name" required></div><div><label>Chất liệu</label><select id="p-material"><option>Nitrile</option><option>Latex</option></select></div></div><div class="row cols-4"><div><label>Size</label><select id="p-size"><option>S</option><option>M</option><option>L</option><option>XL</option></select></div><div><label>Màu</label><select id="p-color"><option>Xanh</option><option>Trắng</option><option>Đen</option></select></div><div><label>Độ dày (mil)</label><input id="p-thick" type="number" min="0" step="0.1"></div><div><label>Điểm đặt hàng</label><input id="p-reorder" type="number" min="0" value="0"></div></div><div class="row cols-3"><div><label>Găng/hộp</label><input id="p-perbox" type="number" min="1" value="100"></div><div><label>Hộp/thùng</label><input id="p-percarton" type="number" min="1" value="10"></div><div><label>Giá vốn/hộp (VND)</label><input id="p-cost" type="number" min="0" value="0"></div></div><div class="row cols-2"><div><label>Giá bán/hộp (VND)</label><input id="p-price" type="number" min="0" value="0"></div><div><label>Ghi chú</label><input id="p-note"></div></div><input type="hidden" id="p-id"></form></div>
        <div class="foot"><button class="btn" id="btn-cancel-prod">Hủy</button><button class="btn primary" id="btn-save-prod">Lưu</button></div>
      </div>
    </section>
    <section class="wrap hidden" id="view-txn">
      <div class="panel">
        <div class="hd"><h2>Ghi nhận giao dịch kho</h2></div>
        <div class="bd"><form id="txn-form" class="grid"><div class="row cols-4"><div><label>Loại giao dịch</label><select id="t-type"><option value="IN">Nhập kho</option><option value="OUT">Xuất kho</option><option value="ADJ">Điều chỉnh</option></select></div><div><label>Sản phẩm</label><select id="t-prod"></select></div><div><label>Số lượng</label><div class="flex" style="gap:8px"><input id="t-qty" type="number" min="1" value="1" style="flex:1"><select id="t-unit"><option value="BOX">Hộp</option><option value="CARTON">Thùng</option></select></div></div><div><label>Ngày</label><input id="t-date" type="date"></div></div><div class="row cols-4"><div><label>Số lô</label><input id="t-lot" placeholder="VD: GGVN-2408-01"></div><div><label>Hạn dùng</label><input id="t-exp" type="date"></div><div><label>Kho</label><input id="t-warehouse" placeholder="VD: Kho Q12"></div><div><label>Ghi chú</label><input id="t-note" placeholder="VD: nhập từ NCC A"></div></div></form><div class="hint">Định mức: <span id="unit-hint">—</span> | FEFO: <span id="fefo-hint">—</span></div></div>
        <div class="foot"><button class="btn" id="btn-clear-txn">Xóa trắng</button><button class="btn primary" id="btn-add-txn">Thêm giao dịch</button></div>
      </div>
      <div class="panel">
        <div class="hd"><h2>Giao dịch gần đây</h2><div class="flex right"><button class="btn" id="btn-undo" disabled>Hoàn tác giao dịch cuối</button><button class="btn" id="btn-export-txn">Xuất CSV</button></div></div>
        <div class="bd" style="overflow-x:auto"><table id="txn-table"><thead><tr><th>Ngày</th><th>Loại</th><th>SKU</th><th>Tên</th><th>SL (hộp)</th><th>Lô</th><th>HSD</th><th>Kho</th><th>Ghi chú</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
    </section>
    <section class="wrap hidden" id="view-count">
      <div class="panel"><div class="hd"><h2>Tạo phiếu kiểm kê</h2></div><div class="bd"><div class="row cols-4"><div><label>Tên phiên kiểm</label><input id="c-name" placeholder="Kiểm kho tháng 8"></div><div><label>Ngày</label><input id="c-date" type="date"></div><div><label>Ghi chú</label><input id="c-note" placeholder="Đếm theo hộp"></div><div class="center"><button class="btn primary" id="c-start">Tạo danh sách</button></div></div></div></div>
      <div class="panel" id="count-panel" style="display:none"><div class="hd"><h2 id="count-title">Phiếu kiểm</h2></div><div class="bd" style="overflow-x:auto"><table id="count-table"><thead><tr><th>SKU</th><th>Tên</th><th>Tồn hệ thống</th><th>Thực đếm</th><th>Chênh lệch</th></tr></thead><tbody></tbody></table></div><div class="foot"><button class="btn" id="c-print">In phiếu</button><button class="btn" id="c-cancel">Hủy</button><button class="btn primary" id="c-commit">Ghi nhận chênh lệch (ADJ)</button></div></div>
    </section>
    <section class="wrap hidden" id="view-report">
      <div class="panel"><div class="hd"><h2>Báo cáo nhập xuất tồn</h2></div><div class="bd"><div class="row cols-4"><div><label>Từ ngày</label><input type="date" id="r-from"></div><div><label>Đến ngày</label><input type="date" id="r-to"></div><div><label>Kho</label><select id="r-warehouse"><option value="">Tất cả kho</option></select></div><div class="center"><button class="btn primary" id="btn-run-report">Chạy báo cáo</button></div></div></div></div>
      <div class="panel" id="report-result-panel" style="display:none"><div class="hd"><h2>Kết quả báo cáo</h2><button class="btn right" id="btn-export-report">Xuất CSV</button></div><div class="bd" style="overflow-x:auto"><table id="report-table"><thead><tr><th>SKU</th><th>Tên</th><th>Tồn đầu kỳ</th><th>Nhập</th><th>Xuất</th><th>Điều chỉnh</th><th>Tồn cuối kỳ</th></tr></thead><tbody></tbody></table></div></div>
    </section>
    <section class="wrap hidden" id="view-settings">
      <div class="panel"><div class="hd"><h2>Sao lưu & Khởi tạo</h2></div><div class="bd grid cols-2"><div class="stat"><div class="k">Sao lưu dữ liệu</div><div class="v" style="font-size:14px;font-weight:500">Tải tệp JSON chứa sản phẩm & giao dịch</div><div style="margin-top:10px" class="flex"><button class="btn" id="btn-export-json">Tải JSON</button><label class="btn ghost" for="import-json">Phục hồi JSON<input id="import-json" type="file" accept="application/json" style="display:none"></label></div><div class="hint" style="margin-top:8px">Khuyến nghị sao lưu mỗi ngày.</div></div><div class="stat"><div class="k">Dữ liệu mẫu</div><div class="v" style="font-size:14px;font-weight:500">Tạo 4 SKU mẫu và vài giao dịch</div><div style="margin-top:10px" class="flex"><button class="btn" id="btn-seed">Tạo dữ liệu mẫu</button><button class="btn danger" id="btn-reset">Xóa toàn bộ dữ liệu</button></div><div class="hint" style="margin-top:8px">Không thể hoàn tác khi xóa.</div></div></div></div>
    </section>
  </main>
  <div class="toast" id="toast"></div>

  <!-- ===================================================================== -->
  <!-- TOÀN BỘ JAVASCRIPT NÊN ĐƯỢC ĐẶT Ở ĐÂY, NGAY TRƯỚC THẺ ĐÓNG </body> -->
  <!-- Điều này đảm bảo tất cả HTML đã được tải xong trước khi script chạy. -->
  <!-- ===================================================================== -->
  <script>
    // Bọc toàn bộ code trong một hàm (IIFE) để tránh làm "bẩn" global scope.
    (function() {
      // --- UTILITIES ---
      const $ = (s, c = document) => c.querySelector(s);
      const $$ = (s, c = document) => Array.from(c.querySelectorAll(s));
      const fmt = new Intl.NumberFormat('vi-VN');
      const money = v => fmt.format(Math.round(Number(v || 0)));
      const today = () => new Date().toISOString().slice(0, 10);
      const uuid = () => crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2);
      const toast = m => {
        const t = $('#toast');
        t.textContent = m;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2400)
      };

      // --- DATABASE (LOCALSTORAGE) ---
      const DB = {
        key: 'gg_inv_v1',
        load() {
          const raw = localStorage.getItem(this.key);
          if (!raw) return { products: [], txns: [], settings: {} };
          try {
            return JSON.parse(raw)
          } catch (e) {
            console.error("Failed to parse data from localStorage", e);
            return { products: [], txns: [], settings: {} }
          }
        },
        save(d) {
          try {
            localStorage.setItem(this.key, JSON.stringify(d));
            window.dispatchEvent(new Event('datachanged'));
          } catch (e) {
            console.error("Failed to save data to localStorage", e);
            toast("Lỗi: Không thể lưu dữ liệu.");
          }
        },
        get data() { return this.load() },
        set data(d) { this.save(d) },
        reset() { this.save({ products: [], txns: [], settings: {} }) }
      };

      // --- CORE LOGIC ---
      const App = {
        state: {
          currentView: 'dash',
          editingProductId: null,
          countSession: null,
        },
        
        get products() { return DB.data.products || [] },
        get txns() { return DB.data.txns || [] },

        getProduct(id) {
          return this.products.find(p => p.id === id);
        },

        calculateStock(productId, atDate = null, wh = '') {
            let stock = 0;
            const relevantTxns = this.txns
                .filter(t => t.productId === productId && (!atDate || t.date <= atDate) && (!wh || t.wh === wh))
                .sort((a, b) => a.date.localeCompare(b.date));

            for (const t of relevantTxns) {
                const qty = Number(t.qty) || 0;
                if (t.type === 'ADJ') {
                    stock = qty;
                } else if (t.type === 'OUT') {
                    stock -= qty;
                } else { // IN
                    stock += qty;
                }
            }
            return stock;
        },
        
        stockLots(productId, wh = '') {
          const lots = {};
          this.txns.filter(t => t.productId === productId && t.lot && (!wh || t.wh === wh)).forEach(t => {
              const key = t.lot + '|' + (t.expiry || '');
              if (!lots[key]) lots[key] = { lot: t.lot, expiry: t.expiry || '', qty: 0 };
              const qty = Number(t.qty) || 0;
              if (t.type === 'OUT') lots[key].qty -= qty;
              else if (t.type === 'ADJ') lots[key].qty = qty; // Note: ADJ on a lot level is complex, this is a simplification
              else lots[key].qty += qty;
          });
          return Object.values(lots)
              .filter(l => l.qty > 0)
              .sort((a, b) => (a.expiry || '9999-99-99').localeCompare(b.expiry || '9999-99-99'));
        },

        nextExpiring(productId, wh = '') {
          const lots = this.stockLots(productId, wh);
          return lots.length ? lots[0] : null;
        },

        init() {
          this.render();
          this.attachListeners();
          $('#t-date').value = today();
          $('#c-date').value = today();
          $('#r-to').value = today();
          const oneMonthAgo = new Date();
          oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
          $('#r-from').value = oneMonthAgo.toISOString().slice(0, 10);
          
          if (localStorage.getItem('gg_theme') === 'light') {
              document.documentElement.setAttribute('data-theme', 'light');
          }
        },

        attachListeners() {
          $('#tabs').addEventListener('click', e => {
            if (e.target.classList.contains('tab')) {
              this.state.currentView = e.target.dataset.tab;
              this.render();
            }
          });
          
          $('#theme-toggle').addEventListener('click', () => {
              const currentTheme = document.documentElement.getAttribute('data-theme');
              if (currentTheme === 'light') {
                  document.documentElement.removeAttribute('data-theme');
                  localStorage.removeItem('gg_theme');
              } else {
                  document.documentElement.setAttribute('data-theme', 'light');
                  localStorage.setItem('gg_theme', 'light');
              }
          });

          window.addEventListener('datachanged', () => this.render());

          $('#btn-new-prod').addEventListener('click', () => this.showProdForm());
          $('#btn-cancel-prod').addEventListener('click', () => this.hideProdForm());
          $('#btn-save-prod').addEventListener('click', () => this.saveProduct());
          $('#prod-table tbody').addEventListener('click', e => {
            if (e.target.closest('.btn-edit')) this.editProduct(e.target.closest('.btn-edit').dataset.id);
            if (e.target.closest('.btn-delete')) this.deleteProduct(e.target.closest('.btn-delete').dataset.id);
          });
          $('#btn-export-products').addEventListener('click', () => this.exportProductsToCsv());

          $('#btn-add-txn').addEventListener('click', () => this.addTransaction());
          $('#btn-clear-txn').addEventListener('click', () => {
              $('#txn-form').reset();
              $('#t-date').value = today();
          });
          $('#t-prod').addEventListener('change', () => this.updateTxnHints());
          $('#btn-undo').addEventListener('click', () => this.undoLastTransaction());
          $('#btn-export-txn').addEventListener('click', () => this.exportTxnsToCsv());
          $('#txn-table tbody').addEventListener('click', e => {
              if (e.target.closest('.btn-delete-txn')) this.deleteTransaction(e.target.closest('.btn-delete-txn').dataset.id);
          });

          ['#dash-search', '#f-size', '#f-color', '#f-material', '#f-status', '#f-warehouse'].forEach(sel => {
              $(sel).addEventListener('input', () => this.renderStockTable());
          });

          $('#c-start').addEventListener('click', () => this.startCount());
          $('#c-cancel').addEventListener('click', () => this.cancelCount());
          $('#c-commit').addEventListener('click', () => this.commitCount());
          $('#c-print').addEventListener('click', () => window.print());

          $('#btn-run-report').addEventListener('click', () => this.runReport());
          $('#btn-export-report').addEventListener('click', () => this.exportReportToCsv());

          $('#btn-seed').addEventListener('click', () => this.seedData());
          $('#btn-reset').addEventListener('click', () => this.resetData());
          $('#btn-export-json').addEventListener('click', () => this.exportJson());
          $('#import-json').addEventListener('change', e => this.importJson(e));
        },

        render() {
          $$('main > section').forEach(el => el.classList.add('hidden'));
          $(`#view-${this.state.currentView}`).classList.remove('hidden');

          switch (this.state.currentView) {
            case 'dash': this.renderDashboard(); break;
            case 'products': this.renderProducts(); break;
            case 'txn': this.renderTransactions(); break;
            case 'report': this.populateWarehouseFilter(); break;
          }
          this.updateUndoButton();
        },

        renderDashboard() {
          const allProducts = this.products;
          let totalStock = 0;
          let totalValue = 0;

          allProducts.forEach(p => {
            const stock = this.calculateStock(p.id);
            totalStock += stock;
            totalValue += stock * (Number(p.cost) || 0);
          });

          $('#stat-skus').textContent = allProducts.length;
          $('#stat-stock').textContent = money(totalStock);
          $('#stat-value').textContent = money(totalValue);

          this.renderLowStockList();
          this.renderExpiryList();
          this.renderStockTable();
          this.populateWarehouseFilter();
        },
        
        populateWarehouseFilter() {
          const warehouses = [...new Set(this.txns.map(t => t.wh).filter(Boolean))];
          const dashSelect = $('#f-warehouse');
          const reportSelect = $('#r-warehouse');
          const currentDashVal = dashSelect.value;
          const currentReportVal = reportSelect.value;
          
          dashSelect.innerHTML = '<option value="">Kho (tất cả)</option>';
          reportSelect.innerHTML = '<option value="">Kho (tất cả)</option>';
          
          warehouses.sort().forEach(wh => {
              dashSelect.innerHTML += `<option value="${wh}">${wh}</option>`;
              reportSelect.innerHTML += `<option value="${wh}">${wh}</option>`;
          });
          dashSelect.value = currentDashVal;
          reportSelect.value = currentReportVal;
        },

        renderLowStockList() {
          const lowStockProducts = this.products.filter(p => {
            const stock = this.calculateStock(p.id);
            return stock <= (Number(p.reorder) || 0) && p.reorder > 0;
          });

          const list = $('#low-list');
          if (lowStockProducts.length === 0) {
            list.innerHTML = `<div class="hint">Không có sản phẩm nào dưới mức đặt hàng.</div>`;
            return;
          }
          list.innerHTML = lowStockProducts.map(p => `
            <div class="flex" style="justify-content:space-between; padding: 4px 0;">
              <span>${p.name} (SKU: ${p.sku})</span>
              <span class="tag">Tồn: ${money(this.calculateStock(p.id))} / Đặt: ${money(p.reorder)}</span>
            </div>
          `).join('');
        },

        renderExpiryList() {
          const expiringLots = [];
          const daysThreshold = 90;
          const thresholdDate = new Date();
          thresholdDate.setDate(thresholdDate.getDate() + daysThreshold);

          this.products.forEach(p => {
            this.stockLots(p.id).forEach(lot => {
              if (lot.expiry) {
                const expiryDate = new Date(lot.expiry);
                if (expiryDate <= thresholdDate) {
                  expiringLots.push({ product: p, lot });
                }
              }
            });
          });

          expiringLots.sort((a, b) => new Date(a.lot.expiry) - new Date(b.lot.expiry));

          const list = $('#exp-list');
          if (expiringLots.length === 0) {
            list.innerHTML = `<div class="hint">Không có lô nào sắp hết hạn trong ${daysThreshold} ngày tới.</div>`;
            return;
          }
          list.innerHTML = expiringLots.map(({ product, lot }) => `
            <div class="flex" style="justify-content:space-between; padding: 4px 0;">
              <span>${product.name} (Lô: ${lot.lot})</span>
              <span class="tag" style="color:var(--warn)">HSD: ${lot.expiry}</span>
            </div>
          `).join('');
        },

        renderStockTable() {
          const tbody = $('#stock-table tbody');
          const searchTerm = $('#dash-search').value.toLowerCase();
          const fSize = $('#f-size').value;
          const fColor = $('#f-color').value;
          const fMaterial = $('#f-material').value;
          const fStatus = $('#f-status').value;
          const fWarehouse = $('#f-warehouse').value;

          const filteredProducts = this.products.filter(p => {
              const stock = this.calculateStock(p.id, null, fWarehouse);
              const reorderPoint = Number(p.reorder) || 0;
              const matchSearch = searchTerm === '' || Object.values(p).some(val => String(val).toLowerCase().includes(searchTerm));
              const matchSize = fSize === '' || p.size === fSize;
              const matchColor = fColor === '' || p.color === fColor;
              const matchMaterial = fMaterial === '' || p.material === fMaterial;
              const matchStatus = fStatus === '' || (fStatus === 'low' && stock <= reorderPoint && reorderPoint > 0) || (fStatus === 'ok' && stock > reorderPoint);
              
              return matchSearch && matchSize && matchColor && matchMaterial && matchStatus;
          });

          if (filteredProducts.length === 0) {
              tbody.innerHTML = `<tr><td colspan="8" class="hint" style="text-align:center;padding:20px;">Không tìm thấy sản phẩm.</td></tr>`;
              return;
          }

          tbody.innerHTML = filteredProducts.map(p => {
            const stock = this.calculateStock(p.id, null, fWarehouse);
            const value = stock * (Number(p.cost) || 0);
            const nextExp = this.nextExpiring(p.id, fWarehouse);
            const reorderPoint = Number(p.reorder) || 0;
            const stockClass = stock <= reorderPoint && reorderPoint > 0 ? 'style="color:var(--warn)"' : '';
            
            return `
              <tr>
                <td>${p.sku}</td>
                <td>${p.name}</td>
                <td>${p.size}, ${p.color}, ${p.material}</td>
                <td ${stockClass}><b>${money(stock)}</b></td>
                <td>${money(reorderPoint)}</td>
                <td>${money(p.cost)}</td>
                <td>${money(value)}</td>
                <td>${nextExp ? `${nextExp.lot} (${nextExp.expiry || 'N/A'})` : '—'}</td>
              </tr>
            `;
          }).join('');
        },

        renderProducts() {
          const tbody = $('#prod-table tbody');
          if (this.products.length === 0) {
              tbody.innerHTML = `<tr><td colspan="12" class="hint" style="text-align:center;padding:20px;">Chưa có sản phẩm nào. Hãy nhấn "+ Thêm sản phẩm".</td></tr>`;
              return;
          }
          tbody.innerHTML = [...this.products].sort((a,b) => a.sku.localeCompare(b.sku)).map(p => `
            <tr>
              <td>${p.sku}</td>
              <td>${p.name}</td>
              <td>${p.size}</td>
              <td>${p.color}</td>
              <td>${p.material}</td>
              <td>${p.thick || '—'}</td>
              <td>${p.perbox}</td>
              <td>${p.percarton}</td>
              <td>${money(p.cost)}</td>
              <td>${money(p.price)}</td>
              <td>${money(p.reorder)}</td>
              <td class="nowrap">
                <button class="btn btn-edit" data-id="${p.id}">Sửa</button>
                <button class="btn btn-delete" data-id="${p.id}">Xóa</button>
              </td>
            </tr>
          `).join('');
        },

        renderTransactions() {
          const tbody = $('#txn-table tbody');
          const sortedTxns = [...this.txns].sort((a, b) => (b.date + b.id).localeCompare(a.date + a.id));
          
          if (sortedTxns.length === 0) {
              tbody.innerHTML = `<tr><td colspan="10" class="hint" style="text-align:center;padding:20px;">Chưa có giao dịch nào.</td></tr>`;
              return;
          }

          tbody.innerHTML = sortedTxns.slice(0, 100).map(t => {
            const p = this.getProduct(t.productId);
            const typeMap = { 'IN': 'Nhập', 'OUT': 'Xuất', 'ADJ': 'Điều chỉnh' };
            const typeClass = { 'IN': 'color:var(--ok)', 'OUT': 'color:var(--danger)', 'ADJ': 'color:var(--warn)' };
            return `
              <tr>
                <td>${t.date}</td>
                <td style="${typeClass[t.type]}"><b>${typeMap[t.type]}</b></td>
                <td>${p ? p.sku : 'N/A'}</td>
                <td>${p ? p.name : 'Sản phẩm đã xóa'}</td>
                <td>${t.type === 'OUT' ? '-' : ''}${money(t.qty)}</td>
                <td>${t.lot || '—'}</td>
                <td>${t.expiry || '—'}</td>
                <td>${t.wh || '—'}</td>
                <td>${t.note || '—'}</td>
                <td><button class="btn btn-delete-txn" data-id="${t.id}">Xóa</button></td>
              </tr>
            `;
          }).join('');
          this.populateTxnProductSelect();
        },

        populateTxnProductSelect() {
          const select = $('#t-prod');
          const currentVal = select.value;
          select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>' + [...this.products].sort((a,b) => a.name.localeCompare(b.name)).map(p =>
            `<option value="${p.id}">${p.name} (SKU: ${p.sku})</option>`
          ).join('');
          select.value = currentVal;
        },
        
        updateTxnHints() {
          const productId = $('#t-prod').value;
          if (!productId) {
              $('#unit-hint').textContent = '—';
              $('#fefo-hint').textContent = '—';
              return;
          }
          const p = this.getProduct(productId);
          $('#unit-hint').textContent = `1 thùng = ${p.percarton} hộp`;
          
          const nextExp = this.nextExpiring(productId);
          if (nextExp) {
              $('#fefo-hint').textContent = `Lô xuất đi gần nhất: ${nextExp.lot} (HSD: ${nextExp.expiry || 'N/A'}), tồn: ${money(nextExp.qty)}`;
          } else {
              $('#fefo-hint').textContent = `Sản phẩm chưa có lô nào.`
          }
        },
        
        updateUndoButton() {
          $('#btn-undo').disabled = this.txns.length === 0;
        },

        showProdForm() {
          this.state.editingProductId = null;
          $('#prod-form-panel').style.display = 'block';
          $('#prod-form-title').textContent = 'Thêm sản phẩm mới';
          $('#prod-form').reset();
          $('#p-sku').focus();
        },

        hideProdForm() {
          $('#prod-form-panel').style.display = 'none';
        },

        saveProduct() {
          const sku = $('#p-sku').value.trim();
          const name = $('#p-name').value.trim();
          if (!sku || !name) {
            toast("Lỗi: SKU và Tên sản phẩm là bắt buộc.");
            return;
          }

          const data = DB.data;
          const newProduct = {
            id: this.state.editingProductId || uuid(),
            sku, name,
            material: $('#p-material').value,
            size: $('#p-size').value,
            color: $('#p-color').value,
            thick: $('#p-thick').value,
            reorder: $('#p-reorder').value,
            perbox: $('#p-perbox').value,
            percarton: $('#p-percarton').value,
            cost: $('#p-cost').value,
            price: $('#p-price').value,
            note: $('#p-note').value,
          };

          if (this.state.editingProductId) {
            const index = data.products.findIndex(p => p.id === this.state.editingProductId);
            data.products[index] = newProduct;
            toast("Đã cập nhật sản phẩm.");
          } else {
            if (data.products.some(p => p.sku.toLowerCase() === sku.toLowerCase())) {
                toast("Lỗi: SKU đã tồn tại.");
                return;
            }
            data.products.push(newProduct);
            toast("Đã thêm sản phẩm mới.");
          }
          DB.data = data;
          this.hideProdForm();
        },

        editProduct(id) {
          const p = this.getProduct(id);
          if (!p) return;
          this.showProdForm();
          $('#prod-form-title').textContent = 'Chỉnh sửa sản phẩm';
          this.state.editingProductId = id;

          $('#p-id').value = p.id;
          $('#p-sku').value = p.sku;
          $('#p-name').value = p.name;
          $('#p-material').value = p.material;
          $('#p-size').value = p.size;
          $('#p-color').value = p.color;
          $('#p-thick').value = p.thick;
          $('#p-reorder').value = p.reorder;
          $('#p-perbox').value = p.perbox;
          $('#p-percarton').value = p.percarton;
          $('#p-cost').value = p.cost;
          $('#p-price').value = p.price;
          $('#p-note').value = p.note;
        },

        deleteProduct(id) {
          if (!confirm("Bạn có chắc muốn xóa sản phẩm này? Mọi giao dịch liên quan sẽ không hiển thị tên sản phẩm nữa.")) return;
          const data = DB.data;
          data.products = data.products.filter(p => p.id !== id);
          DB.data = data;
          toast("Đã xóa sản phẩm.");
        },
        
        deleteTransaction(id) {
          if (!confirm("Bạn có chắc muốn xóa vĩnh viễn giao dịch này? Hành động này không thể hoàn tác.")) return;
          const data = DB.data;
          data.txns = data.txns.filter(t => t.id !== id);
          DB.data = data;
          toast("Đã xóa giao dịch.");
        },

        addTransaction() {
          const productId = $('#t-prod').value;
          if (!productId) {
            toast("Vui lòng chọn một sản phẩm.");
            return;
          }
          const product = this.getProduct(productId);
          const qtyInput = Number($('#t-qty').value);
          const unit = $('#t-unit').value;
          const qtyInBoxes = unit === 'CARTON' ? qtyInput * (Number(product.percarton) || 1) : qtyInput;
          
          if (qtyInBoxes <= 0) {
              toast("Số lượng phải lớn hơn 0.");
              return;
          }

          const data = DB.data;
          const newTxn = {
            id: uuid(),
            productId,
            type: $('#t-type').value,
            qty: qtyInBoxes,
            date: $('#t-date').value || today(),
            lot: $('#t-lot').value.trim(),
            expiry: $('#t-exp').value,
            wh: $('#t-warehouse').value.trim(),
            note: $('#t-note').value.trim(),
          };
          data.txns.push(newTxn);
          DB.data = data;
          toast("Đã thêm giao dịch.");
          $('#txn-form').reset();
          $('#t-date').value = today();
        },
        
        undoLastTransaction() {
          if (this.txns.length === 0) return;
          if (!confirm("Bạn có chắc muốn hoàn tác (xóa) giao dịch cuối cùng?")) return;
          
          const data = DB.data;
          data.txns.sort((a, b) => (b.date + b.id).localeCompare(a.date + a.id));
          data.txns.shift();
          DB.data = data;
          toast("Đã hoàn tác giao dịch cuối cùng.");
        },

        startCount() {
          const name = $('#c-name').value || 'Kiểm kê';
          const date = $('#c-date').value || today();
          const note = $('#c-note').value;

          this.state.countSession = { name, date, note, items: [] };
          const tbody = $('#count-table tbody');
          
          this.state.countSession.items = this.products.map(p => {
              const stock = this.calculateStock(p.id);
              return {
                  productId: p.id,
                  sku: p.sku,
                  name: p.name,
                  systemStock: stock,
              };
          });
          
          tbody.innerHTML = this.state.countSession.items.map(item => `
              <tr>
                  <td>${item.sku}</td>
                  <td>${item.name}</td>
                  <td>${money(item.systemStock)}</td>
                  <td><input type="number" class="count-input" data-id="${item.productId}" value="${item.systemStock}"></td>
                  <td class="count-diff" data-id="${item.productId}">0</td>
              </tr>
          `).join('');
          
          $('#count-title').textContent = `Phiếu kiểm: ${name} - ${date}`;
          $('#count-panel').style.display = 'block';
          
          $$('.count-input').forEach(input => {
              input.addEventListener('input', e => {
                  const id = e.target.dataset.id;
                  const sessionItem = this.state.countSession.items.find(i => i.productId === id);
                  const counted = Number(e.target.value) || 0;
                  const diff = counted - sessionItem.systemStock;
                  $(`.count-diff[data-id="${id}"]`).textContent = money(diff);
              });
          });
        },
        
        cancelCount() {
          if (!confirm("Hủy phiên kiểm kê này?")) return;
          this.state.countSession = null;
          $('#count-panel').style.display = 'none';
        },
        
        commitCount() {
          if (!this.state.countSession || !confirm("Ghi nhận chênh lệch? Thao tác này sẽ tạo các giao dịch ĐIỀU CHỈNH (ADJ) cho các sản phẩm có chênh lệch.")) return;
          
          const data = DB.data;
          let adjCount = 0;
          
          $$('.count-input').forEach(input => {
              const id = input.dataset.id;
              const counted = Number(input.value) || 0;
              const sessionItem = this.state.countSession.items.find(i => i.productId === id);
              
              if (counted !== sessionItem.systemStock) {
                  adjCount++;
                  const diff = counted - sessionItem.systemStock;
                  const newTxn = {
                      id: uuid(),
                      productId: id,
                      type: 'ADJ',
                      qty: counted,
                      date: this.state.countSession.date,
                      note: `Kiểm kê: ${this.state.countSession.name}. Chênh lệch ${diff > 0 ? '+' : ''}${diff}`,
                  };
                  data.txns.push(newTxn);
              }
          });
          
          if (adjCount > 0) {
              DB.data = data;
              toast(`Đã tạo ${adjCount} giao dịch điều chỉnh.`);
          } else {
              toast("Không có chênh lệch nào được ghi nhận.");
          }
          
          this.state.countSession = null;
          $('#count-panel').style.display = 'none';
        },

        runReport() {
            const from = $('#r-from').value;
            const to = $('#r-to').value;
            const wh = $('#r-warehouse').value;

            if (!from || !to) {
                toast("Vui lòng chọn Từ ngày và Đến ngày.");
                return;
            }

            const reportData = this.products.map(p => {
                const fromDateForStock = new Date(from);
                fromDateForStock.setDate(fromDateForStock.getDate() - 1);
                const stockStart = this.calculateStock(p.id, fromDateForStock.toISOString().slice(0, 10), wh);

                const txnsInPeriod = this.txns.filter(t => t.productId === p.id && t.date >= from && t.date <= to && (!wh || t.wh === wh));
                
                let totalIn = 0, totalOut = 0, totalAdjValue = 0;
                let lastStock = stockStart;

                txnsInPeriod.sort((a,b)=>a.date.localeCompare(b.date)).forEach(t => {
                    const qty = Number(t.qty) || 0;
                    if (t.type === 'IN') totalIn += qty;
                    else if (t.type === 'OUT') totalOut += qty;
                    else if (t.type === 'ADJ') {
                        totalAdjValue += (qty - lastStock);
                    }
                    lastStock = this.calculateStock(p.id, t.date, wh);
                });
                
                const stockEnd = stockStart + totalIn - totalOut + totalAdjValue;

                return { sku: p.sku, name: p.name, stockStart, totalIn, totalOut, totalAdj: totalAdjValue, stockEnd };
            });

            const tbody = $('#report-table tbody');
            tbody.innerHTML = reportData.map(r => `
                <tr>
                    <td>${r.sku}</td>
                    <td>${r.name}</td>
                    <td>${money(r.stockStart)}</td>
                    <td>${money(r.totalIn)}</td>
                    <td>${money(r.totalOut)}</td>
                    <td>${money(r.totalAdj)}</td>
                    <td>${money(r.stockEnd)}</td>
                </tr>
            `).join('');
            $('#report-result-panel').style.display = 'block';
            this.state.lastReport = reportData;
        },
        
        exportToCsv(filename, rows) {
          if (rows.length === 0) return;
          const header = Object.keys(rows[0]).join(',');
          const csvContent = rows.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')).join('\n');
          const blob = new Blob(["\uFEFF" + header + '\n' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          link.click();
        },

        exportProductsToCsv() {
          if (this.products.length === 0) { toast("Không có sản phẩm để xuất."); return; }
          this.exportToCsv('products.csv', this.products);
        },
        
        exportTxnsToCsv() {
          if (this.txns.length === 0) { toast("Không có giao dịch để xuất."); return; }
          const dataToExport = this.txns.map(t => {
              const p = this.getProduct(t.productId);
              return { date: t.date, type: t.type, sku: p ? p.sku : 'N/A', product_name: p ? p.name : 'N/A', quantity_boxes: t.qty, lot: t.lot, expiry: t.expiry, warehouse: t.wh, note: t.note };
          });
          this.exportToCsv('transactions.csv', dataToExport);
        },

        exportReportToCsv() {
          if (!this.state.lastReport || this.state.lastReport.length === 0) { toast("Chưa có báo cáo để xuất. Vui lòng chạy báo cáo trước."); return; }
          this.exportToCsv('inventory_report.csv', this.state.lastReport);
        },

        exportJson() {
          const dataStr = JSON.stringify(DB.data, null, 2);
          const blob = new Blob([dataStr], {type: "application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `golden-gloves-backup-${today()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          toast("Đã xuất tệp sao lưu JSON.");
        },

        importJson(event) {
          const file = event.target.files[0];
          if (!file) return;
          if (!confirm("Phục hồi từ tệp JSON sẽ GHI ĐÈ toàn bộ dữ liệu hiện tại. Bạn có chắc chắn?")) return;
          
          const reader = new FileReader();
          reader.onload = e => {
              try {
                  const importedData = JSON.parse(e.target.result);
                  if (importedData.products && importedData.txns) {
                      DB.data = importedData;
                      toast("Đã phục hồi dữ liệu thành công.");
                  } else {
                      toast("Lỗi: Tệp JSON không hợp lệ.");
                  }
              } catch (err) {
                  toast("Lỗi: Không thể đọc tệp JSON.");
                  console.error(err);
              }
          };
          reader.readAsText(file);
          event.target.value = '';
        },
        
        seedData() {
          if (!confirm("Tạo dữ liệu mẫu? Dữ liệu hiện tại sẽ bị xóa.")) return;
          const sampleData = {
              products: [
                  {id: "p1", sku: "NBLS", name: "Găng Nitrile Xanh Size S", material: "Nitrile", size: "S", color: "Xanh", thick: "4.5", reorder: "50", perbox: "100", percarton: "10", cost: "55000", price: "75000", note: ""},
                  {id: "p2", sku: "NBLM", name: "Găng Nitrile Xanh Size M", material: "Nitrile", size: "M", color: "Xanh", thick: "4.5", reorder: "100", perbox: "100", percarton: "10", cost: "55000", price: "75000", note: ""},
                  {id: "p3", sku: "LWHL", name: "Găng Latex Trắng Size L", material: "Latex", size: "L", color: "Trắng", thick: "5.0", reorder: "20", perbox: "100", percarton: "10", cost: "50000", price: "70000", note: ""},
                  {id: "p4", sku: "NBKX", name: "Găng Nitrile Đen Size XL", material: "Nitrile", size: "XL", color: "Đen", thick: "4.0", reorder: "10", perbox: "100", percarton: "10", cost: "60000", price: "85000", note: ""}
              ],
              txns: [
                  {id: "t1", productId: "p1", type: "IN", qty: 100, date: "2025-08-01", lot: "L001", expiry: "2027-08-01", wh: "Kho A", note: "Nhập hàng đầu kỳ"},
                  {id: "t2", productId: "p2", type: "IN", qty: 200, date: "2025-08-02", lot: "L002", expiry: "2027-08-02", wh: "Kho A", note: "Nhập hàng đầu kỳ"},
                  {id: "t3", productId: "p3", type: "IN", qty: 50, date: "2025-08-03", lot: "L003", expiry: "2026-08-03", wh: "Kho B", note: "Nhập hàng đầu kỳ"},
                  {id: "t4", productId: "p2", type: "OUT", qty: 20, date: "2025-08-10", note: "Xuất cho khách X"},
                  {id: "t5", productId: "p1", type: "OUT", qty: 10, date: "2025-08-12", note: "Xuất cho khách Y"},
              ],
              settings: {}
          };
          DB.data = sampleData;
          toast("Đã tạo dữ liệu mẫu thành công.");
        },
        
        resetData() {
          if (!confirm("CẢNH BÁO: Thao tác này sẽ XÓA TOÀN BỘ dữ liệu sản phẩm và giao dịch. Không thể hoàn tác. Bạn có chắc chắn muốn tiếp tục?")) return;
          DB.reset();
          toast("Đã xóa toàn bộ dữ liệu.");
        }
      };

      // --- START THE APP ---
      // Sự kiện này đảm bảo code chỉ chạy sau khi toàn bộ HTML đã được tải.
      document.addEventListener('DOMContentLoaded', () => App.init());
    })();
  </script>
</body>
</html>
